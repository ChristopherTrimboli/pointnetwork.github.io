"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8451],{3905:function(t,e,n){n.d(e,{Zo:function(){return d},kt:function(){return h}});var r=n(67294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e){if(null==t)return{};var n,r,a=function(t,e){if(null==t)return{};var n,r,a={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var l=r.createContext({}),p=function(t){var e=r.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},d=function(t){var e=p(t.components);return r.createElement(l.Provider,{value:e},t.children)},s={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},u=r.forwardRef((function(t,e){var n=t.components,a=t.mdxType,o=t.originalType,l=t.parentName,d=c(t,["components","mdxType","originalType","parentName"]),u=p(n),h=a,m=u["".concat(l,".").concat(h)]||u[h]||s[h]||o;return n?r.createElement(m,i(i({ref:e},d),{},{components:n})):r.createElement(m,i({ref:e},d))}));function h(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var o=n.length,i=new Array(o);i[0]=u;var c={};for(var l in e)hasOwnProperty.call(e,l)&&(c[l]=e[l]);c.originalType=t,c.mdxType="string"==typeof t?t:a,i[1]=c;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},47811:function(t,e,n){n.r(e),n.d(e,{frontMatter:function(){return c},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return d},default:function(){return u}});var r=n(83117),a=n(80102),o=(n(67294),n(3905)),i=["components"],c={id:"build-upgrade-identity-contract",title:"Upgrade the Identity contract",sidebar_label:"Upgrade the Identity contract",slug:"../build-upgrade-identity-contract"},l=void 0,p={unversionedId:"build/build-upgrade-identity-contract",id:"build/build-upgrade-identity-contract",title:"Upgrade the Identity contract",description:"The Identity contract is at the heart of Point Network. Sometimes it needs to have some functionality added to it over time.",source:"@site/docs/build/build-upgrade-identity-contract.md",sourceDirName:"build",slug:"/build-upgrade-identity-contract",permalink:"/docs/build-upgrade-identity-contract",editUrl:"https://github.com/pointnetwork/pointnetwork.github.io/edit/main/website/docs/build/build-upgrade-identity-contract.md",tags:[],version:"current",lastUpdatedBy:"sergevar",lastUpdatedAt:1658831636,formattedLastUpdatedAt:"7/26/2022",frontMatter:{id:"build-upgrade-identity-contract",title:"Upgrade the Identity contract",sidebar_label:"Upgrade the Identity contract",slug:"../build-upgrade-identity-contract"},sidebar:"pnSidebar",previous:{title:"Using Identity Oracle in dev",permalink:"/docs/build-use-identity-oracle-in-devlocal"},next:{title:"Testing Guide",permalink:"/docs/build-testing-guide"}},d=[{value:"Overview",id:"overview",children:[],level:3},{value:"Technical Process",id:"technical-process",children:[],level:3},{value:"Troubleshooting",id:"troubleshooting",children:[],level:3},{value:"Interact with Identity Contract in Hardhat Console",id:"interact-with-identity-contract-in-hardhat-console",children:[],level:3}],s={toc:d};function u(t){var e=t.components,n=(0,a.Z)(t,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,n,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The Identity contract is at the heart of Point Network. Sometimes it needs to have some functionality added to it over time. "),(0,o.kt)("p",null,"In this page we will outline how to upgrade the deployed Identity contract and how to interact with the Identity contract in a Hardhat console."),(0,o.kt)("h3",{id:"overview"},"Overview"),(0,o.kt)("p",null,"To upgrade the Identity contract with a new version you need to perform the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Ensure that the Identity contract owners seed phrase is currently saved in the ",(0,o.kt)("inlineCode",{parentName:"li"},"~/.point/keystore/key.json")," file. This is automatically parsed in the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/pointnetwork/point-contracts/blob/main/hardhat.config.ts#L24"},"hardhat config")," file when connecting to Ynet."),(0,o.kt)("li",{parentName:"ol"},"Compile the Identity contract"),(0,o.kt)("li",{parentName:"ol"},"Run the Hardhat task to update the contract on a specific network (Ynet)"),(0,o.kt)("li",{parentName:"ol"},"Commit the updated ",(0,o.kt)("inlineCode",{parentName:"li"},"unknown-10700.json")," file to the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/pointnetwork/point-contracts/"},"point-contracts")," repo so that it can be referenced for the next contract upgrade."),(0,o.kt)("li",{parentName:"ol"},"Update the Identity contract ABI file in Arweave"),(0,o.kt)("li",{parentName:"ol"},"Copy the Areweave file hash and use that to update the ",(0,o.kt)("inlineCode",{parentName:"li"},"default.yaml")," file in the Point Engine repo.")),(0,o.kt)("h3",{id:"technical-process"},"Technical Process"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Ensure that the Identity contract owners seed phrase is currently saved in the ",(0,o.kt)("inlineCode",{parentName:"p"},"~/.point/keystore/key.json")," file. "),(0,o.kt)("p",{parentName:"li"},"This step can be done by logging into Point Network via the Point Dashboard using the seed phrase of the Identity owner. "),(0,o.kt)("p",{parentName:"li"},"This is needed because ",(0,o.kt)("strong",{parentName:"p"},"only the owner")," of the Identity contract can upgrade it. ")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Compile the contract"),(0,o.kt)("p",{parentName:"li"},"Use Hardhat to compile the Identity contract like so:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"npx hardhat compile\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the Hardhat task to update the contract on a specific network"),(0,o.kt)("p",{parentName:"li"},"To update the Identity contract you can run the following command from the cloned ",(0,o.kt)("inlineCode",{parentName:"p"},"point-contracts")," repo folder"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"npx hardhat identity-update-contract 0x1574E97F7a60c4eE518f6d7c0Fa701eff8Ab58b3 ./resources/unknown-10700.json --network ynet\n")),(0,o.kt)("p",{parentName:"li"},"Details are in the ",(0,o.kt)("inlineCode",{parentName:"p"},"identity-update-contract")," task source code ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pointnetwork/point-contracts/blob/main/tasks/identity/identity-update-contract.ts"},"here"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Commit the updated ",(0,o.kt)("inlineCode",{parentName:"p"},"unknown-10700.json")," file to the point-contracts repo"),(0,o.kt)("p",{parentName:"li"},"Commit ",(0,o.kt)("inlineCode",{parentName:"p"},"unknown-10700.json")," file after running the command to store proxy metadata for further deployments.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Update the Identity contract ABI file in Arweave"),(0,o.kt)("p",{parentName:"li"},"This has to be done using the ",(0,o.kt)("inlineCode",{parentName:"p"},"point")," cli and so you will need to cd into the Point Engine repo first."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"cd pointnetwork\n./point upload ../point-contracts/build/contracts/Identity.sol/Identity.json\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Copy the Areweave file hash and use that to update the ",(0,o.kt)("inlineCode",{parentName:"p"},"default.yml")," file in the Point Engine repo."),(0,o.kt)("p",{parentName:"li"},"The returned Arweave file hash for the Identity contract ABI needs to be set in the ",(0,o.kt)("inlineCode",{parentName:"p"},"identity_contract_id")," key of the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pointnetwork/pointnetwork/blob/develop/config/default.yaml#L3"},"default.yaml")," file in the Point Engine repo."))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Make sure to remember to commit all the code changes back to Github and to check the deployment of the contract.")),(0,o.kt)("h3",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"If you see the following errors after running the upgrade script..."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Error: Timed out waiting for implementation contract deployment to address")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"cannot estimate gas; transaction may fail or may require manual gas limit UNPREDICTABLE_GAS_LIMIT")),(0,o.kt)("p",null,"...try this workaround to ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/OpenZeppelin/openzeppelin-upgrades/issues/85"},"Override transaction options")," (from, gas, gasPrice) in create and upgrade proxy."),(0,o.kt)("h3",{id:"interact-with-identity-contract-in-hardhat-console"},"Interact with Identity Contract in Hardhat Console"),(0,o.kt)("p",null,"Firstly make sure you are in the point-contracts repo and then start hardhat console like so:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cd point-contracts\nnpx hardhat console --network ynet\n")),(0,o.kt)("p",null,"Now in the Hardhat console you can load the Identity contract and start to call functions. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// Load Identity Contract instance\nid = await hre.ethers.getContractAt(\"Identity\", \"0x1574E97F7a60c4eE518f6d7c0Fa701eff8Ab58b3\");\n \n// Check the owner of the Identity contract \nawait id.owner()\n \n// Check dev mode setting\nawait id.getDevMode()\n \n// Fetch IKV values from the contract, e.g.\nawait id.ikvGet('social', 'zweb/contracts/address/PointSocial')\n")))}u.isMDXComponent=!0}}]);