<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css">
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script src="../js/custom.js"></script><title data-react-helmet="true">Storage Layer | Point Network</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pointnetwork.github.io/docs/learn-storage-layer"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Storage Layer | Point Network"><meta data-react-helmet="true" name="description" content="Point Network is a system for building decentralized websites with a distributed storage layer."><meta data-react-helmet="true" property="og:description" content="Point Network is a system for building decentralized websites with a distributed storage layer."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pointnetwork.github.io/docs/learn-storage-layer"><link data-react-helmet="true" rel="alternate" href="https://pointnetwork.github.io/docs/learn-storage-layer" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pointnetwork.github.io/docs/learn-storage-layer" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f62190ed.css">
<link rel="preload" href="/assets/js/runtime~main.9e69aa1b.js" as="script">
<link rel="preload" href="/assets/js/main.ddd307ab.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://pointnetwork.github.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/pointlogo.png" alt="Point Network" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/pointlogo.png" alt="Point Network" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Point Network</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/docs/learn-index">Learn</a><a class="navbar__item navbar__link" href="/docs/build-index">Build</a><a class="navbar__item navbar__link" href="/docs/maintain-index">Maintain</a><a class="navbar__item navbar__link" href="/docs/use-index">Use</a><a class="navbar__item navbar__link" href="/api">API</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">General</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Learn</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn-index">Learner&#x27;s Portal</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Basics</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn-architecture">Architecture</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/learn-storage-layer">Storage Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn-point-deployer">Point Deployer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn-websockets">Web Sockets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/filecoin-vs-pointstorage">Filecoin vs Point Storage</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Advanced</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Cryptography</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn-video-tutorials">Video Tutorials</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Build</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Maintain</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Use</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>Storage Layer</h1></header><p>Point Network is a system for building decentralized websites with a distributed storage layer.</p><header><h1>Point Network Storage Layer</h1></header><p>To save a file in the storage layer, a developer can call the putFile function passing in the file like so: <code>storage.putFile(filePath)</code>. This is a function call that will return the unique file id of the file originally located at the <code>filePath</code>.</p><p>Firstly we can outline this using high level state machine diagrams for <code>File</code>, <code>Chunk</code> and <code>ProviderLink</code> as follows.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="file-states"></a>File States<a class="hash-link" href="#file-states" title="Direct link to heading">#</a></h2><div class="mermaid">
  stateDiagram-v2
    [*] --&gt; Created: putFile
    Created --&gt; Uploading: chunkify
    Uploading --&gt; Uploaded: chunks_uploading==0
    Uploading --&gt; Uploading: chunks_uploading&gt;0
    Uploaded --&gt; [*]
</div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chunk-states"></a>Chunk States<a class="hash-link" href="#chunk-states" title="Direct link to heading">#</a></h2><div class="mermaid">
  stateDiagram-v2
    [*] --&gt; Created: createChunkFromFile
    Created --&gt; Uploading: check state
    Uploading --&gt; Uploading: chunk conditions NOT satisfied
    Uploading --&gt; Uploaded: chunk conditions satisfied
    Uploaded --&gt; [*]
</div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="storage-link-states"></a>Storage Link States<a class="hash-link" href="#storage-link-states" title="Direct link to heading">#</a></h2><div class="mermaid">
  stateDiagram-v2
    [*] --&gt; Created
    Created --&gt; Agreed
    Created --&gt; Failed
    note left of Created: STORE_CHUNK_REQUEST
    Agreed --&gt; Establish_payment_channel:Payment channel does not exists
    Agreed --&gt; Encrypting:Payment channel already exists
    Establish_payment_channel --&gt; Encrypting
    Encrypting --&gt; Encrypted
    Encrypting --&gt; Failed
    Encrypted --&gt; SendingSegmentMap
    note left of SendingSegmentMap: STORE_CHUNK_SEGMENTS
    SendingSegmentMap --&gt; SendingData
    note left of SendingData: STORE_CHUNK_DATA
    SendingSegmentMap --&gt; Failed
    SendingData --&gt; DataReceived
    SendingData --&gt; Failed
    DataReceived --&gt; AskingForSignature
    AskingForSignature --&gt; Signed
    AskingForSignature --&gt; Failed
    note left of AskingForSignature: STORE_CHUNK_SIGNATURE_REQUEST
    Failed --&gt; [*]
    Signed --&gt; [*]
    note left of Signed: SEND_MICROPAYMENT_FOR_CHUNK
</div><p>NOTE: Yellow boxes represent communication to the linked node.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="process-upload-and-chunkify-file"></a>Process: upload and chunkify file<a class="hash-link" href="#process-upload-and-chunkify-file" title="Direct link to heading">#</a></h2><ol><li><p><code>Storage.putFile</code> - the public storage interface for storing a file on the network. It calls <code>Storage.enqueueFileForUpload</code> and waits to get the file id of the file (file may not be uploaded yet). Then waits until the File uploading status is <code>File.UPLOADING_STATUS_UPLOADED</code>. It also calls <code>Storage.chunkUploadingTick</code> to ensure the chunks are uploaded based on the expectations set in the file metadata.</p></li><li><p><code>Storage.enqueueFileForUpload</code>- This calls <code>File.chunkify</code> (see details below) and sets the files metadata for redundancy, expiry and auto renew policies. Once the file is broken into chunks it calls <code>File.reconsiderUploadingStatus</code> (see below).</p></li><li><p><code>File.chunkify</code> - splits the file by breaking the file into chunks of equal size of bytes upto the last chunk which may be smaller in size. It also creates a merkle tree using the chunk ids as the leaves. Each chunk has an initial state of <code>Chunk.UPLOADING_STATUS_CREATED</code>.</p></li><li><p><code>File.reconsiderUploadingStatus</code> - sets the chunks metadata for <strong>redundancy</strong>, <strong>expiry</strong> and <strong>auto renew</strong> policies and then calls <code>Chunk.reconsiderUploadingStatus</code> for each chunk (see below).</p></li><li><p><code>Chunk.reconsiderUploadingStatus</code> - checks that the chunk has the expected data redundancy (i.e. that it is stored in at least N providers) and that it has not expired. If any of these are not settled then the status of the chunk is set to Chunk.<code>UPLOADING_STATUS_UPLOADING</code> otherwise it is considered uploaded and so the status is set to <code>Chunk.UPLOADING_STATUS_UPLOADED</code></p></li><li><p><code>Storage.chunkUploadingTick</code> - this function is called as a result of the original call to <code>Storage.putFile</code> and it is also called on every ‘tick’ if there are any chunks that have a status Chunk.<code>UPLOADING_STATUS_UPLOADING</code>. In this function the chunks Storage Links  are pushed through various states of the uploading process and we can run though these states in the next step.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="process-checking-upload-status"></a>Process: checking upload status<a class="hash-link" href="#process-checking-upload-status" title="Direct link to heading">#</a></h2><p>The <code>Storage.chunkUploadingTick</code> function checks, and potentially, modifies the state of all the Storage Links of an uploading file chunk. The state of the chunk must be in <code>Chunk.UPLOADING_STATUS_UPLOADING</code> for this function to proceed.</p><p>The function proceeds as follows:</p><ol><li><p>Checks if the uploading chunk is required to be pushed to additional storage providers. It does this by fetching all the Storage Links for the chunk that have not failed and then compares that with the chunk redundancy to determine if more are required.</p></li><li><p><code>StorageLink.STATUS_CREATED</code>: If additional Storage Providers are required then one is chosen using <code>chooseProviderCandidate()</code> function. The process of choosing a provider candidate is detailed elsewhere in the docs. A new Storage Link is created and the provider, <strong>redkeyId</strong>, and <strong>chunk id</strong> is set on this new instance.</p></li><li><p><code>StorageLink.STATUS_AGREED</code>: A <code>STORE_CHUNK_REQUEST</code> call is made to the linked Storage Provider and if agreed a check to determine if there is an existing payment channel between the client and the storage provider is carried out using <code>checkExistingChannel()</code> function. If a channel exists the status is updated to <code>StorageLink.STATUS_AGREED</code> otherwise it is updated to <code>StorageLink.STATUS_ESTABLISH_PAYMENT_CHANNEL</code> if the <code>STORE_CHUNK_REQUEST</code> call fails it is updated to <code>StorageLink.STATUS_FAILED</code>. The <code>STORE_CHUNK_REQUEST</code> call is handled using a custom Kademlia plugin or middleware that defines this handler (more on networking in a separate section of the documentation). Note this is a request to another node to store the chunk and at this point the actual chunk data is not sent to the other node - only the id, length and expiry parameters are sent.</p></li><li><p><code>StorageLink.STATUS_ESTABLISH_PAYMENT_CHANNEL</code>: The function then checks in the  <code>StorageLink.STATUS_ESTABLISH_PAYMENT_CHANNEL</code> state and creates a payment channel with the Storage Provider using <code>createChannel()</code> function. if successful the status is updated to <code>StorageLink.STATUS_AGREED</code>.</p></li><li><p><code>StorageLink.STATUS_ENCRYPTING</code>: The function then checks all the Storage Links in the <code>StorageLink.STATUS_AGREED</code> state and begins the encryption process. The Storage Link state is first updated to <code>StorageLink.STATUS_ENCRYPTING</code>  and then the encryption process is performed by a forked child process that returns a message to the parent process when the encryption is complete.</p></li><li><p><code>StorageLink.STATUS_ENCRYPTED</code>: The resulting encrypted chunk is split into multiple segment hashes used to produce a Merkle Tree representation of the chunk. This is then used to update the Storage Link once more with the resulting encrypted hash, encryption data length, segment hashes, merkle tree and merkle tree root. The status is updated to <code>StorageLink.STATUS_ENCRYPTED</code> at this point or <code>StorageLink.STATUS_FAILED</code> if the encryption process failed.</p></li><li><p>StorageLink.STATUS_SENDING_SEGMENT_MAP: The function then checks all the Storage Links in the <code>StorageLink.STATUS_ENCRYPTED</code> state and begins sending the segment map to the linked Storage Provider. It first sets the state to <code>StorageLink.STATUS_SENDING_SEGMENT_MAP</code> and then calls <code>STORE_CHUNK_SEGMENTS</code> on the linked Storage Provider. The status is then updated to either <code>StorageLink.STATUS_SENDING_DATA</code> if the request was successful or <code>StorageLink.STATUS_DATA_RECEIVED</code> if the response was ECHUNKALREADYSTORED from the linked Storage Provider. As always, if there was an error then the status is set to <code>StorageLink.STATUS_FAILED</code> .</p></li><li><p><code>StorageLink.STATUS_SENDING_DATA</code>: The function then checks all the Storage Links in the <code>StorageLink.STATUS_SENDING_DATA</code> state and then prepares the data to be sent to the linked Storage Provider (which includes checking if chunks should be retransmitted due to a timeout condition). Once the data is prepared it calls <code>STORE_CHUNK_DATA</code>  which will invoke the equivalent function on the linked Storage Provider instance which will then store the data sent. On successful transmission of the data the Storage Link status is updated to <code>StorageLink.STATUS_DATA_RECEIVED</code> otherwise it is updated to <code>StorageLink.STATUS_FAILED</code>.</p></li><li><p><code>StorageLink.STATUS_DATA_RECEIVED</code>: The function then checks all the Storage Links in the <code>StorageLink.STATUS_DATA_RECEIVED</code> state and updates the state to <code>StorageLink.STATUS_ASKING_FOR_SIGNATURE</code> and then sends a request to the linked Storage Provider for it to sign the chunk. Once it is successfully signed the status is changed to <code>StorageLink.STATUS_SIGNED</code> and the agreed micropayment is made to the Storage Provider using the makePayment() function. otherwise it is updated to <code>StorageLink.STATUS_FAILED</code>.</p></li></ol></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"></div><div class="col lastUpdated_13-_">Last updated on <b><time datetime="2021-08-27T04:19:17.000Z">8/27/2021</time></b> by <b>Darren Jensen</b></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/learn-architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Architecture</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/learn-point-deployer"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Point Deployer »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#file-states" class="table-of-contents__link">File States</a></li><li><a href="#chunk-states" class="table-of-contents__link">Chunk States</a></li><li><a href="#storage-link-states" class="table-of-contents__link">Storage Link States</a></li><li><a href="#process-upload-and-chunkify-file" class="table-of-contents__link">Process: upload and chunkify file</a></li><li><a href="#process-checking-upload-status" class="table-of-contents__link">Process: checking upload status</a></li></ul></div></div></div></div></main></div></div><footer class="nav-footer spacer-y-4 pb-4" id="footer"><div class="container"><div class="justify-content-start row"><div class="mb-3 mb-md-0 col-md-3 col-6"><h5 class="text-white">General</h5><ul class="list-unstyled"><li class="py-0 py-md-1"><a href="https://pointnetwork.io/page/about" class="text-white" target="_blank" rel="noopener noreferrer">About</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.io/" class="text-white" target="_blank" rel="noopener noreferrer">FAQ</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.io/page/social" class="text-white" target="_blank" rel="noopener noreferrer">Contact</a></li><li class="py-0 py-md-1"><a href="/docs/build-index" class="text-white" target="_blank" rel="noopener noreferrer">Build</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.io/page/social" class="text-white" target="_blank" rel="noopener noreferrer">Careers</a></li></ul></div><div class="mb-3 mb-md-0 col-md-3 col-6"><h5 class="text-white">Technology</h5><ul class="list-unstyled"><li class="py-0 py-md-1"><a href="https://pointnetwork.io/" class="text-white" target="_blank" rel="noopener noreferrer">Technology</a></li><li class="py-0 py-md-1"><a href="/docs/point-token" class="text-white" target="_blank" rel="noopener noreferrer">Token</a></li><li class="py-0 py-md-1"><a href="https://docs.google.com/document/d/16bcqsnezTKnPyYI7g32gEkrmJE35z8U4Zj0lUUXXQDY/edit" class="text-white" target="_blank" rel="noopener noreferrer">Whitepaper</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.io/files/PointNetworkBrochure-c003.pdf" class="text-white" target="_blank" rel="noopener noreferrer">Lightpaper</a></li></ul></div><div class="mb-3 mb-md-0 col-md-3 col-6"><h5 class="text-white">Community</h5><ul class="list-unstyled"><li class="py-0 py-md-1"><a href="https://pointnetwork.io/page/social" class="text-white" target="_blank" rel="noopener noreferrer">Community</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.github.io/docs/getting-started" class="text-white" target="_blank" rel="noopener noreferrer">Documentation</a></li><li class="py-0 py-md-1"><a href="https://pointnetwork.io/page/blog" class="text-white" target="_blank" rel="noopener noreferrer">Blog</a></li><li class="py-0 py-md-1"><a href="https://t.me/pointnetworkchat" class="text-white" target="_blank" rel="noopener noreferrer">Telegram Chat</a></li></ul></div><div class="px-lg-0 col-md-3"><ul class="list-social-links justify-content-around"><li class="text-white"><a href="https://twitter.com/pointnetwork" target="_blank" rel="noopener noreferrer"><i class="socicon-twitter"></i></a></li><li class="text-white"><a href="https://www.reddit.com/r/pointnetwork/" target="_blank" rel="noopener noreferrer"><i class="socicon-reddit"></i></a></li><li class="text-white"><a href="https://github.com/pointnetwork" target="_blank" rel="noopener noreferrer"><i class="socicon-github"></i></a></li><li class="text-white"><a href="https://www.youtube.com/channel/UCWZkr5qbQhmMtD4Zt374-FA" target="_blank" rel="noopener noreferrer"><i class="socicon-youtube"></i></a></li><li class="text-white"><a href="https://t.me/pointnetworkchat" target="_blank" rel="noopener noreferrer"><i class="socicon-telegram"></i></a></li></ul><p class="d-block text-white">Subscribe to the newsletter to hear about Point Network updates and events.</p><button type="button" class="btn btn-primary"><a href="https://pointnetwork.io/" target="_blank" style="color:white">Subscribe</a></button></div></div><div class="footer-legal align-items-end mt-5 pt-4 row"><div class="mb-2 mb-lg-0 col-lg-2"><a class="navbar-brand" href="https://pointnetwork.io" target="_blank" rel="noopener noreferrer"></a></div><div class="col-lg-10"><ul class="list-unstyled d-flex flex-wrap list-pipe-separator"><li><a href="https://pointnetwork.io" class="text-white text-small" target="_blank" rel="noopener noreferrer">Copyright © 2021 Point Network Limited</a></li><li><a href="https://t.me/pointnetworkchat" class="text-white text-small" target="_blank" rel="noopener noreferrer">Telegram</a></li><li><a href="https://pointnetwork.io/pages/terms" class="text-white text-small" target="_blank" rel="noopener noreferrer">Terms</a></li><li><a href="https://pointnetwork.io/pages/privacy" class="text-white text-small" target="_blank" rel="noopener noreferrer">Privacy</a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.9e69aa1b.js"></script>
<script src="/assets/js/main.ddd307ab.js"></script>
</body>
</html>