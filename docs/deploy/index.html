<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<title data-react-helmet="true">Deploy | Point Network</title><meta data-react-helmet="true" property="og:url" content="https://pointnetwork.github.io/docs/deploy"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Deploy | Point Network"><meta data-react-helmet="true" name="description" content="This document outlines a high level overview of the process of deploying files to Point Network via the point cli. This document follows the journey of a file as it is uploaded, parsed and finally passed onto the Point Network storage layer for distribution among Point Network nodes."><meta data-react-helmet="true" property="og:description" content="This document outlines a high level overview of the process of deploying files to Point Network via the point cli. This document follows the journey of a file as it is uploaded, parsed and finally passed onto the Point Network storage layer for distribution among Point Network nodes."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pointnetwork.github.io/docs/deploy"><link data-react-helmet="true" rel="alternate" href="https://pointnetwork.github.io/docs/deploy" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pointnetwork.github.io/docs/deploy" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b14f3733.css">
<link rel="preload" href="/assets/js/runtime~main.b1e06f44.js" as="script">
<link rel="preload" href="/assets/js/main.60a9d279.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://pointnetwork.io/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/pointlogo.png" alt="Point Network" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/pointlogowhite.png" alt="Point Network" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Point Network</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Getting Started</a><a class="navbar__item navbar__link" href="/api/">API</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://pointnetwork.io/" target="_self" rel="noopener noreferrer" class="navbar__brand"><img src="/img/pointlogo.png" alt="Point Network" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/pointlogowhite.png" alt="Point Network" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Point Network</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/api/">API</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modules">Modules</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/deploy">Deploy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage">Storage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/token">Token</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">File Deployment Process</h1></header><p>This document outlines a high level overview of the process of deploying files to Point Network via the <code>point cli</code>. This document follows the journey of a file as it is uploaded, parsed and finally passed onto the Point Network storage layer for distribution among Point Network nodes.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-1-initialization"></a>Step 1: Initialization<a class="hash-link" href="#step-1-initialization" title="Direct link to heading">#</a></h2><ol><li><p>At least one Point Network node must already be running. The config file of the desired data directory (set using the <code>--datadir</code> cli option) is used to load the config of that running node.</p></li><li><p>The point CLI will wrap an instance of a <code>Console</code> class and make an API call to the Point Network API <code>/deploy</code> endpoint as defined in the loaded config file of the previous step. The call will include the <code>deploy_path</code> query string parameter that will be used by the deployer to locate the files to deploy. The API call may look something like this: http://localhost:2469/deploy?deploy_path=/my/path/to/example/example.z</p></li><li><p>The call to the Point Network API endpoint will hit the <code>DeployController</code> which passes the call onto the <code>ZWeb Deployer</code> class, <code>deploy</code> function. Now we move to the next step: Parsing files.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-2-process-routes-and-smart-contracts"></a>Step 2: Process Routes and Smart Contracts<a class="hash-link" href="#step-2-process-routes-and-smart-contracts" title="Direct link to heading">#</a></h2><ol><li><p>The <code>ZWeb Deployer</code> class <code>deploy</code> function is primarily responsible for parsing the template files that are part of the deployment. Once the template is parsed, it&#x27;s handed off to the storage layer for persistence (which is covered in detail in the next Step).</p></li><li><p>The <code>deploy</code> function first reads the <code>point.deploy.json</code> file that must be available in the <code>deploy_path</code>. The <code>target</code> property of the <code>point.deploy.json</code> file is then used as the <code>Identity</code> that the deployed resources will be bound to in the Identity Smart Contract (essentially its the domain name, and therefore the owner, that the resources belong to).</p></li><li><p>Deployment of new Smart Contracts (if any) are then deployed. The list of Smart Contracts to deploy is provided in the <code>contracts</code> key in the  <code>point.deploy.json</code> file. A separate <code>deployContract</code> function is used to deploy the Contracts. Essentially the <code>deployContract</code>  function compiles and deploys the Smart Contract in a standard way using <code>Web3</code> and the <code>@truffle/contract</code> libraries. The interesting thing to note is that the Contract Artifacts are stored in the Point Network Storage layer with the contract address and contract artifacts storage id being persisted in the Identity Smart Contract as key / value pairs as follows:</p><ul><li><code>zweb/contracts/address/contractName -&gt; address</code></li><li><code>zweb/contracts/abi/contractName -&gt; artifactsStorageId </code></li></ul></li><li><p>The <code>routes.json</code> file is a core part of a ZWeb deployment. It essentially acts as a DNS for the deployed files on the Point Network. When loaded initially, the file will contain human readable references to each of the files in the domain (for example, it may contain an entry like <code>&quot;/welcome&quot;: &quot;welcome.zhtml&quot;</code>).  The <code>deploy</code> function will iterate each entry in the routes file and pass that to the <code>processTemplate</code> function for parsing (discussed in the next Step).</p><p>The interesting part is that the <code>processTemplate</code> function returns the new file id of the file just parsed and the key in the routes file is replaced with this new id. So for example the value for the key <code>“/welcome”</code> will be updated to the file id <code>&quot;d1f4740f49adfad36e2a5fe4193b334b76d8ecf6&quot;</code>. NOTE: the file id is the randomly generated id of the file record in the LevelDB which has another mapping to the actual filename stored on disk (which might be <code>6251fc539f02c6f2e3669a47c21dbc072e59a38b</code>). The actual file is stored under the Point Network nodes data/deployer_cache directory.</p><p>Once the function has parsed all the files referenced in the <code>routes.json</code> then the routes file (containing the file ids now - not the human readable names) is persisted to the storage layer. Moreover, the ZDNS record is updated in the Identity Smart Contract against the target (which is the Identity as mentioned earlier) with a key <code>zdns/routes</code> and value is the randomly generated file id for the <code>routes.json</code> file.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-3-parsing-content"></a>Step 3: Parsing Content<a class="hash-link" href="#step-3-parsing-content" title="Direct link to heading">#</a></h2><ol><li>Optionally the <code>point.deploy.json</code> file may contain a <code>keyvalue</code> option. This contains the content for the site being deployed. The function <code>updateKeyValue</code> recursively loops the values until the value is either a string, Array or Object that can be ultimately represented as a JSON string. Each key / value pair is stored against the target in the Idently smart contract.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-4-parsing-templates"></a>Step 4: Parsing Templates<a class="hash-link" href="#step-4-parsing-templates" title="Direct link to heading">#</a></h2><ol><li><p>The main part of the <code>deploy</code> function  is the calls to the  <code>processTemplate</code> function.</p></li><li><p>The simplest case is when the template file being processed is not a ‘zhtml’ template file. In this case the file is hashed and this is used as the filename which is persisted in the nodes <code>data/deployer_cache</code> directory. Examples would be stylesheet CSS files which do not require parsing by the ZWeb deployment process.</p></li><li><p>The parser then checks for any <code>extends</code> references (e.g. <code>{% extends &#x27;layout.html&#x27; %}</code> ) and will extract that filename used (i.e. layout.zhtml) and then simply recursively calls the <code>processTemplate</code> function with that filename.</p><p>The interesting part is that the returned file id from the sub <code>processTemplate</code> call is used to replace the human readable filename with that file id like so: <code>{% extends &#x27;51c78cf25d8b32ab6d426ab7f2f70943f3bb5344&#x27; %}</code>.</p></li><li><p>Next any <code>link</code> and <code>img</code> tags in the template are processed recursively so that all these are also replaced with the file id reference in the parsed template. Again the result is that the human readable referenced filename with parsed file id but this time referencing the storage table in the LevelDB and including the file extension. So one example of a parsed img tag might look like this:<code>&lt;img src=&quot;/_storage/7de460700a2b69c8241e76593165e76ca29bc3ef.png&quot;&gt;</code></p></li><li><p>Finally, once the template has been fully parsed, it is sent to the Point Network Storage Layer for persistence across the network.</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-08-25T04:34:32.000Z">8/25/2021</time></b> by <b>Darren Jensen</b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/modules"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Modules</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/storage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Storage »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#step-1-initialization" class="table-of-contents__link">Step 1: Initialization</a></li><li><a href="#step-2-process-routes-and-smart-contracts" class="table-of-contents__link">Step 2: Process Routes and Smart Contracts</a></li><li><a href="#step-3-parsing-content" class="table-of-contents__link">Step 3: Parsing Content</a></li><li><a href="#step-4-parsing-templates" class="table-of-contents__link">Step 4: Parsing Templates</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/pointlogo.png" alt="" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/pointlogowhite.png" alt="" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright © 2021 Point Network Limited</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b1e06f44.js"></script>
<script src="/assets/js/main.60a9d279.js"></script>
</body>
</html>